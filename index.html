<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pilot Logbook Professional</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --cockpit-bg: #0f172a;
            --panel-bg: #1e293b;
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
        }

        body {
            font-family: 'Inter', 'Malgun Gothic', sans-serif;
            background-color: var(--cockpit-bg);
            color: #f1f5f9;
            letter-spacing: -0.01em;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        input, select {
            background: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid #334155 !important;
            transition: all 0.2s ease;
        }

        input:focus {
            border-color: var(--accent-blue) !important;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transition: transform 0.1s active;
        }

        /* 커스텀 스크롤바 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--cockpit-bg); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .hidden-screen { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1700px] mx-auto">
        
        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="flex flex-col items-center justify-center min-h-[85vh]">
            <div class="glass-panel p-12 rounded-3xl text-center max-w-md w-full border-t-4 border-blue-500">
                <div class="mb-6 inline-flex p-4 rounded-2xl bg-blue-500/10 text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2 tracking-tight">Pilot Logbook</h1>
                <p class="text-slate-400 mb-8 font-medium">Professional Flight Records Management</p>
                <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-blue-900/20">
                    Sync via Cloud
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="main-content" class="hidden-screen">
            <!-- Header -->
            <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
                <div>
                    <h2 class="text-3xl font-extrabold text-white tracking-tight flex items-center gap-3">
                        FLIGHT OPERATIONS <span class="bg-blue-500 text-[10px] px-2 py-1 rounded text-white font-bold uppercase tracking-widest">Live Sync</span>
                    </h2>
                    <p class="text-slate-400 mt-1 flex items-center gap-2">
                        <span id="user-display" class="font-mono text-blue-400 text-sm"></span>
                        <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                        <span class="text-xs uppercase tracking-tighter">System Ready</span>
                    </p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls">
                    <button onclick="document.getElementById('excel-input').click()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-5 py-2.5 rounded-lg text-sm font-semibold border border-slate-700 flex items-center gap-2 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Import Excel
                    </button>
                    <button id="btn-export" class="bg-emerald-600/10 hover:bg-emerald-600 text-emerald-400 hover:text-white px-5 py-2.5 rounded-lg text-sm font-semibold border border-emerald-600/30 flex items-center gap-2 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        Export Log
                    </button>
                    <button id="btn-logout" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-5 py-2.5 rounded-lg text-sm font-semibold border border-red-500/30 transition-all">
                        Logout
                    </button>
                </div>
            </header>

            <!-- Input Console -->
            <div class="glass-panel rounded-2xl p-6 mb-8 border-l-4 border-blue-500">
                <form id="flight-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-6">
                        <!-- Group 1: Core Info -->
                        <div class="xl:col-span-2 grid grid-cols-2 gap-3">
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Date</label>
                                <input type="date" id="date" class="w-full rounded-lg px-3 py-2 text-sm" required>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">A/C Registration</label>
                                <input type="text" id="aircraft" class="w-full rounded-lg px-3 py-2 text-sm uppercase" placeholder="HL0000" required>
                            </div>
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Flt No</label>
                                <input type="text" id="fltNo" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="KE121">
                            </div>
                            <div class="col-span-1 flex gap-2">
                                <div class="w-1/2">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">From</label>
                                    <input type="text" id="from" class="w-full rounded-lg px-3 py-2 text-sm uppercase" placeholder="RKSS" required>
                                </div>
                                <div class="w-1/2">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">To</label>
                                    <input type="text" id="to" class="w-full rounded-lg px-3 py-2 text-sm uppercase" placeholder="RKPC" required>
                                </div>
                            </div>
                        </div>

                        <!-- Group 2: Time Info -->
                        <div class="xl:col-span-3 grid grid-cols-3 md:grid-cols-6 gap-3 bg-slate-800/30 p-3 rounded-xl border border-slate-700/50">
                            <div>
                                <label class="block text-[10px] font-bold text-blue-400 uppercase mb-1.5">Block</label>
                                <input type="text" id="blockTime" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00" required>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-emerald-400 uppercase mb-1.5">PIC</label>
                                <input type="text" id="pic" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">PIC Supv</label>
                                <input type="text" id="picSupv" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">CoPilot</label>
                                <input type="text" id="coPilot" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">TR</label>
                                <input type="text" id="tr" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-1.5">Night</label>
                                <input type="text" id="night" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                        </div>

                        <!-- Group 3: Ops Info -->
                        <div class="xl:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">INST</label>
                                <input type="text" id="instTime" class="w-full rounded-lg px-3 py-2 text-sm text-center" placeholder="0:00">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">T/O</label>
                                <input type="number" id="toCount" class="w-full rounded-lg px-3 py-2 text-sm text-center" value="1">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">L/D</label>
                                <input type="number" id="ldCount" class="w-full rounded-lg px-3 py-2 text-sm text-center" value="1">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Wx</label>
                                <input type="text" id="wx" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="VFR">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mt-6 pt-6 border-t border-slate-700/50">
                        <div class="lg:col-span-1">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Landing Condition</label>
                            <input type="text" id="landingCmt" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="Normal">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Clearance</label>
                            <input type="text" id="clearance" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="IFR">
                        </div>
                        <div class="lg:col-span-2">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5">Remark</label>
                            <input type="text" id="remark" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="Any flight notes...">
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-[10px] font-bold text-amber-500 uppercase mb-1.5">TIP</label>
                            <input type="text" id="tip" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="Personal Tip">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full btn-primary text-white font-bold py-2 rounded-lg text-sm shadow-lg">
                                EXECUTE RECORD
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-5 rounded-2xl flex items-center gap-4">
                    <div class="p-3 rounded-xl bg-blue-500/10 text-blue-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                    <div><p class="text-[10px] font-bold text-slate-500 uppercase">Sorties</p><p id="stat-count" class="text-2xl font-bold">0</p></div>
                </div>
                <div class="glass-panel p-5 rounded-2xl flex items-center gap-4 border-b-2 border-blue-500">
                    <div class="p-3 rounded-xl bg-blue-500/10 text-blue-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                    <div><p class="text-[10px] font-bold text-slate-500 uppercase">Total Block</p><p id="stat-block" class="text-2xl font-bold text-blue-400">0:00</p></div>
                </div>
                <div class="glass-panel p-5 rounded-2xl flex items-center gap-4 border-b-2 border-emerald-500">
                    <div class="p-3 rounded-xl bg-emerald-500/10 text-emerald-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                    <div><p class="text-[10px] font-bold text-slate-500 uppercase">Total PIC</p><p id="stat-pic" class="text-2xl font-bold text-emerald-400">0:00</p></div>
                </div>
                <div class="glass-panel p-5 rounded-2xl flex items-center gap-4 border-b-2 border-indigo-500">
                    <div class="p-3 rounded-xl bg-indigo-500/10 text-indigo-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                    <div><p class="text-[10px] font-bold text-slate-500 uppercase">Total Night</p><p id="stat-night" class="text-2xl font-bold text-indigo-400">0:00</p></div>
                </div>
            </div>

            <!-- Table Console -->
            <div class="glass-panel rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-800/80 border-b border-slate-700">
                            <tr>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">Date</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">A/C Info</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">Route</th>
                                <th class="p-4 font-bold text-blue-400 uppercase text-[10px]">Block</th>
                                <th class="p-4 font-bold text-emerald-400 uppercase text-[10px]">PIC</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">Ops (TR/N/I)</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">LD</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">Remark</th>
                                <th class="p-4 font-bold text-slate-400 uppercase text-[10px]">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="flight-list" class="divide-y divide-slate-800">
                            <tr><td colspan="9" class="p-12 text-center text-slate-500 animate-pulse font-mono uppercase tracking-widest text-xs">Initializing Terminal...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_ZpKW84M8Iocwj3-WueKtPxephXPabts",
            authDomain: "pilot-log-67113.firebaseapp.com",
            projectId: "pilot-log-67113",
            storageBucket: "pilot-log-67113.firebasestorage.app",
            messagingSenderId: "685601607927",
            appId: "1:685601607927:web:d7d6279370881add4f03f2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "pilot-log-67113";

        let flights = [];
        let user = null;
        let unsubscribe = null;

        // Utilities
        const toDisplay = (num) => {
            if (!num || isNaN(num)) return "0:00";
            const h = Math.floor(num);
            const m = Math.round((num - h) * 60);
            return `${h}:${m.toString().padStart(2, '0')}`;
        };

        const parseTime = (str) => {
            if (!str) return 0;
            if (typeof str === 'number') return str;
            const s = String(str).trim();
            if (s.includes(':')) {
                const parts = s.split(':');
                return (parseInt(parts[0]) || 0) + (parseInt(parts[1]) || 0) / 60;
            }
            return parseFloat(s) || 0;
        };

        const render = () => {
            const list = document.getElementById('flight-list');
            if (!list) return;

            if (flights.length === 0) {
                list.innerHTML = '<tr><td colspan="9" class="p-16 text-center text-slate-500 uppercase tracking-widest text-xs">No Records Found</td></tr>';
                return;
            }

            let totals = { block: 0, pic: 0, night: 0, ld: 0 };

            list.innerHTML = flights.map(f => {
                totals.block += (f.blockTime || 0);
                totals.pic += (f.pic || 0);
                totals.night += (f.night || 0);
                totals.ld += (parseInt(f.ldCount) || 0);

                return `
                    <tr class="hover:bg-slate-800/50 transition-colors group">
                        <td class="p-4 text-slate-300 font-mono text-xs">${f.date}</td>
                        <td class="p-4">
                            <div class="font-bold text-slate-100">${f.aircraft}</div>
                            <div class="text-[10px] text-slate-500 font-mono">${f.fltNo || '-'}</div>
                        </td>
                        <td class="p-4">
                            <div class="text-xs font-semibold text-slate-400">${f.from} <span class="text-slate-600 px-1">→</span> ${f.to}</div>
                        </td>
                        <td class="p-4 font-bold text-blue-400 font-mono">${toDisplay(f.blockTime)}</td>
                        <td class="p-4 font-bold text-emerald-400 font-mono">${toDisplay(f.pic)}</td>
                        <td class="p-4 text-[11px] text-slate-400 font-mono">
                            <span title="TR">${toDisplay(f.tr)}</span> / 
                            <span class="text-indigo-400 font-bold">${toDisplay(f.night)}</span> / 
                            <span title="INST">${toDisplay(f.instTime)}</span>
                        </td>
                        <td class="p-4 text-slate-300 font-bold">${f.ldCount || 0}</td>
                        <td class="p-4">
                            <div class="text-xs text-slate-400 truncate max-w-[150px]" title="${f.remark || ''}">${f.remark || '-'}</div>
                            <div class="text-[9px] text-amber-500 italic mt-0.5">${f.tip ? 'Tip: ' + f.tip : ''}</div>
                        </td>
                        <td class="p-4">
                            <button onclick="window.deleteItem('${f.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-3 py-1 rounded text-[10px] font-bold uppercase border border-red-500/20">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('stat-count').innerText = flights.length;
            document.getElementById('stat-block').innerText = toDisplay(totals.block);
            document.getElementById('stat-pic').innerText = toDisplay(totals.pic);
            document.getElementById('stat-night').innerText = toDisplay(totals.night);
        };

        // Auth Logic
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('login-screen').classList.add('hidden-screen');
                document.getElementById('main-content').classList.remove('hidden-screen');
                document.getElementById('user-display').innerText = `PILOT_ID: ${user.uid.substring(0,8).toUpperCase()}`;
                
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'flights'));
                unsubscribe = onSnapshot(q, (snapshot) => {
                    flights = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    flights.sort((a, b) => new Date(b.date) - new Date(a.date));
                    render();
                }, (err) => console.error(err));
            } else {
                if (unsubscribe) unsubscribe();
                document.getElementById('login-screen').classList.remove('hidden-screen');
                document.getElementById('main-content').classList.add('hidden-screen');
            }
        });

        // Global functions for HTML
        window.deleteItem = async (id) => {
            if (confirm("CONFIRM COMMAND: DELETE RECORD?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'flights', id));
            }
        };

        window.handleExcelImport = (e) => {
            const file = e.target.files[0];
            if (!file || !user) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                const rows = jsonData.slice(1);
                for (const row of rows) {
                    if (!row[0] || !row[1]) continue;
                    const flightData = {
                        date: String(row[0]),
                        aircraft: String(row[1]),
                        fltNo: String(row[2] || ''),
                        from: String(row[3] || ''),
                        to: String(row[4] || ''),
                        blockTime: parseTime(row[5]),
                        pic: parseTime(row[6]),
                        picSupv: parseTime(row[7]),
                        coPilot: parseTime(row[8]),
                        tr: parseTime(row[9]),
                        night: parseTime(row[10]),
                        instTime: parseTime(row[11]),
                        toCount: parseInt(row[12]) || 0,
                        ldCount: parseInt(row[13]) || 0,
                        remark: String(row[14] || ''),
                        wx: String(row[15] || ''),
                        landingCmt: String(row[16] || ''),
                        clearance: String(row[17] || ''),
                        tip: String(row[18] || ''),
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'flights'), flightData);
                }
                alert("BATCH IMPORT COMPLETED");
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        };

        window.exportExcel = () => {
            const data = flights.map(f => [
                f.date, f.aircraft, f.fltNo, f.from, f.to, toDisplay(f.blockTime), toDisplay(f.pic), 
                toDisplay(f.picSupv), toDisplay(f.coPilot), toDisplay(f.tr), toDisplay(f.night),
                toDisplay(f.instTime), f.toCount, f.ldCount, f.remark, f.wx, f.landingCmt, f.clearance, f.tip
            ]);
            data.unshift(['Date', 'AC', 'FltNo', 'From', 'To', 'BLOCK', 'PIC', 'PIC_Supv', 'CP', 'TR', 'NIGHT', 'INST', 'T/O', 'L/D', 'Remark', 'Wx', 'Landing', 'Clearance', 'TIP']);
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Logbook");
            XLSX.writeFile(wb, `PilotLog_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // UI Listeners
        document.getElementById('flight-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                date: document.getElementById('date').value,
                aircraft: document.getElementById('aircraft').value,
                fltNo: document.getElementById('fltNo').value,
                from: document.getElementById('from').value,
                to: document.getElementById('to').value,
                blockTime: parseTime(document.getElementById('blockTime').value),
                pic: parseTime(document.getElementById('pic').value),
                picSupv: parseTime(document.getElementById('picSupv').value),
                coPilot: parseTime(document.getElementById('coPilot').value),
                tr: parseTime(document.getElementById('tr').value),
                night: parseTime(document.getElementById('night').value),
                instTime: parseTime(document.getElementById('instTime').value),
                toCount: parseInt(document.getElementById('toCount').value) || 0,
                ldCount: parseInt(document.getElementById('ldCount').value) || 0,
                remark: document.getElementById('remark').value,
                wx: document.getElementById('wx').value,
                landingCmt: document.getElementById('landingCmt').value,
                clearance: document.getElementById('clearance').value,
                tip: document.getElementById('tip').value,
                createdAt: serverTimestamp()
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'flights'), payload);
            e.target.reset();
        };

        document.getElementById('btn-login').onclick = () => signInAnonymously(auth);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-export').onclick = () => window.exportExcel();
        document.getElementById('excel-input').onchange = (e) => window.handleExcelImport(e);
    </script>
</body>
</html>
